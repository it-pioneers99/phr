frappe.ui.form.on('Employee', {
    refresh: function(frm) {
        // Add custom buttons for calculations
        frm.add_custom_button(__('Calculate Leave Balances'), function() {
            calculate_all_leave_balances(frm);
        });
        
        
        
        frm.add_custom_button(__('Calculate Testing Period'), function() {
            calculate_testing_period(frm);
        });
        
        // Add button for automatic leave allocation
        frm.add_custom_button(__('Create Leave Allocations'), function() {
            create_automatic_leave_allocation(frm);
        });
        
        // Add button for sick leave salary calculation
        frm.add_custom_button(__('Calculate Sick Leave Deduction'), function() {
            calculate_sick_leave_deduction_dialog(frm);
        });
        
        // Add dropdown for quick calculations
        frm.add_custom_button(__('Quick Calculations'), function() {
            show_quick_calculations_dialog(frm);
        });
        
        // Show current values in dashboard
        update_dashboard_display(frm);
    },
    
    date_of_joining: function(frm) {
        if (frm.doc.date_of_joining) {
            // Calculate leave balances
            calculate_all_leave_balances(frm);
            
            // Ask if user wants to create automatic leave allocations
            frappe.confirm(
                __('Would you like to create automatic leave allocations for this employee based on their joining date?'),
                function() {
                    create_automatic_leave_allocation(frm);
                }
            );
        }
    },
    
    annual_leave_balance: function(frm) {
        calculate_remaining_leave(frm);
        calculate_sick_leave_remaining(frm);
    },
    
    annual_leave_used: function(frm) {
        calculate_remaining_leave(frm);
    },
    
    sick_leave_balance: function(frm) {
        calculate_sick_leave_remaining(frm);
    },
    
    sick_leave_used: function(frm) {
        calculate_sick_leave_remaining(frm);
    },
    
    is_female: function(frm) {
        if (frm.doc.is_female && frm.doc.is_muslim) {
            frappe.msgprint(__('Employee is both Female and Muslim - can access both Female-only and Muslim-only leave types'));
        }
    },
    
    is_muslim: function(frm) {
        if (frm.doc.is_female && frm.doc.is_muslim) {
            frappe.msgprint(__('Employee is both Female and Muslim - can access both Female-only and Muslim-only leave types'));
        }
    }
});

function calculate_all_leave_balances(frm) {
    if (!frm.doc.date_of_joining) {
        frappe.msgprint(__('Please set the date of joining first'));
        return;
    }
    
    // Calculate years of service
    var joining_date = new Date(frm.doc.date_of_joining);
    var current_date = new Date();
    var years_of_service = (current_date - joining_date) / (1000 * 60 * 60 * 24 * 365.25);
    
    // Determine annual leave allocation based on years of service
    var annual_leave_days = 0;
    if (years_of_service < 5) {
        annual_leave_days = 21; // Less than 5 years
    } else {
        annual_leave_days = 30; // 5 years or more
    }
    
    // Calculate proportional allocation for mid-year joiners
    var current_year = current_date.getFullYear();
    var joining_year = joining_date.getFullYear();
    
    if (joining_year === current_year) {
        var year_start = new Date(current_year, 0, 1);
        var year_end = new Date(current_year, 11, 31);
        var days_in_year = (year_end - year_start) / (1000 * 60 * 60 * 24) + 1;
        var days_worked = (year_end - joining_date) / (1000 * 60 * 60 * 24) + 1;
        var proportional_days = (annual_leave_days * days_worked) / days_in_year;
        annual_leave_days = Math.round(proportional_days * 100) / 100;
    }
    
    frm.set_value('annual_leave_balance', annual_leave_days);
    calculate_remaining_leave(frm);
    
    // Calculate sick leave balance
    var daily_rate = years_of_service < 5 ? 0.0575342466 : 0.0821917808;
    var current_sick_balance = frm.doc.sick_leave_balance || 0;
    var new_sick_balance = parseFloat(current_sick_balance) + daily_rate;
    frm.set_value('sick_leave_balance', new_sick_balance);
    
    calculate_sick_leave_remaining(frm);
    
    let message = `Leave calculated: ${annual_leave_days} days based on ${Math.round(years_of_service * 10) / 10} years of service`;
    if (joining_year === current_year) {
        message += ` (Proportional allocation for mid-year joiner)`;
    }
    
    frappe.msgprint({
        title: __('Leave Calculation Complete'),
        message: message,
        indicator: 'green'
    });
}

function create_automatic_leave_allocation(frm) {
    if (!frm.doc.name) {
        frappe.msgprint(__('Please save the employee record first'));
        return;
    }
    
    if (!frm.doc.date_of_joining) {
        frappe.msgprint(__('Please set the date of joining first'));
        return;
    }
    
    frappe.show_progress(__('Creating Leave Allocations'), 50, 100);
    
    // Create automatic leave allocation using client-side logic
    var joining_date = new Date(frm.doc.date_of_joining);
    var current_date = new Date();
    var years_of_service = (current_date - joining_date) / (1000 * 60 * 60 * 24 * 365.25);
    
    // Determine leave days
    var annual_leave_days = years_of_service >= 5 ? 30 : 21;
    
    // Calculate proportional allocation for mid-year joiners
    var current_year = current_date.getFullYear();
    var joining_year = joining_date.getFullYear();
    
    if (joining_year === current_year) {
        var year_start = new Date(current_year, 0, 1);
        var year_end = new Date(current_year, 11, 31);
        var days_in_year = (year_end - year_start) / (1000 * 60 * 60 * 24) + 1;
        var days_worked = (year_end - joining_date) / (1000 * 60 * 60 * 24) + 1;
        var proportional_days = (annual_leave_days * days_worked) / days_in_year;
        annual_leave_days = Math.round(proportional_days * 100) / 100;
    }
    
    frappe.hide_progress();
    
    // Show allocation creation dialog
    var dialog = new frappe.ui.Dialog({
        title: __('Create Leave Allocations'),
        fields: [
            {
                label: __('Employee'),
                fieldname: 'employee',
                fieldtype: 'Link',
                options: 'Employee',
                default: frm.doc.name,
                read_only: 1
            },
            {
                label: __('Years of Service'),
                fieldname: 'years_of_service',
                fieldtype: 'Float',
                default: Math.round(years_of_service * 100) / 100,
                read_only: 1
            },
            {
                label: __('Annual Leave Days'),
                fieldname: 'annual_leave_days',
                fieldtype: 'Float',
                default: annual_leave_days,
                description: __('Based on years of service and proportional calculation')
            },
            {
                label: __('Sick Leave Days'),
                fieldname: 'sick_leave_days',
                fieldtype: 'Float',
                default: 365,
                description: __('Standard sick leave allocation')
            },
            {
                label: __('Leave Period'),
                fieldname: 'leave_period',
                fieldtype: 'Data',
                default: current_year.toString(),
                read_only: 1
            }
        ],
        primary_action_label: __('Create Allocations'),
        primary_action: function(data) {
            create_leave_allocation_records(data, dialog);
        }
    });
    
    dialog.show();
}

function create_leave_allocation_records(data, dialog) {
    frappe.show_progress(__('Creating Leave Allocations'), 70, 100);
    
    // Create Annual Leave Allocation
    frappe.call({
        method: 'frappe.client.insert',
        args: {
            doc: {
                doctype: 'Leave Allocation',
                employee: data.employee,
                leave_type: 'Annual Leave',
                from_date: data.leave_period + '-01-01',
                to_date: data.leave_period + '-12-31',
                new_leaves_allocated: data.annual_leave_days,
                carry_forward: 0
            }
        },
        callback: function(r) {
            if (r.message) {
                // Submit the allocation
                frappe.call({
                    method: 'frappe.client.submit',
                    args: {
                        doc: r.message
                    },
                    callback: function(submit_r) {
                        // Create Sick Leave Allocation
                        frappe.call({
                            method: 'frappe.client.insert',
                            args: {
                                doc: {
                                    doctype: 'Leave Allocation',
                                    employee: data.employee,
                                    leave_type: 'Sick Leave',
                                    from_date: data.leave_period + '-01-01',
                                    to_date: data.leave_period + '-12-31',
                                    new_leaves_allocated: data.sick_leave_days,
                                    carry_forward: 0
                                }
                            },
                            callback: function(sick_r) {
                                if (sick_r.message) {
                                    // Submit sick leave allocation
                                    frappe.call({
                                        method: 'frappe.client.submit',
                                        args: {
                                            doc: sick_r.message
                                        },
                                        callback: function() {
                                            frappe.hide_progress();
                                            dialog.hide();
                                            frappe.msgprint({
                                                title: __('Success'),
                                                message: __('Leave allocations created successfully'),
                                            });
                                            frm.refresh();
                                        }
                                    });
                                }
                            }
                        });
                    }
                });
            }
        }
    });
}

function calculate_sick_leave_deduction_dialog(frm) {
    if (!frm.doc.name) {
        frappe.msgprint(__('Please save the employee record first'));
        return;
    }
    
    var dialog = new frappe.ui.Dialog({
        title: __('Calculate Sick Leave Salary Deduction'),
        fields: [
            {
                label: __('Employee'),
                fieldname: 'employee',
                fieldtype: 'Link',
                options: 'Employee',
                default: frm.doc.name,
                read_only: 1
            },
            {
                label: __('Sick Leave Days Taken'),
                fieldname: 'sick_days',
                fieldtype: 'Float',
                reqd: 1,
                description: __('Total sick leave days taken in the period')
            },
            {
                label: __('Monthly Salary'),
                fieldname: 'monthly_salary',
                fieldtype: 'Currency',
                reqd: 1,
                description: __('Employee monthly basic salary')
            }
        ],
        primary_action_label: __('Calculate Deduction'),
        primary_action: function(data) {
            calculate_sick_leave_deduction_amount(data, dialog);
        }
    });
    
    dialog.show();
}

function calculate_sick_leave_deduction_amount(data, dialog) {
    var sick_days = parseFloat(data.sick_days);
    var monthly_salary = parseFloat(data.monthly_salary);
    var daily_salary = monthly_salary / 30;
    
    var deduction_amount = 0;
    var deduction_details = [];
    
    if (sick_days <= 30) {
        // First 30 days - no deduction
        deduction_amount = 0;
        deduction_details.push(`Days 1-${Math.min(sick_days, 30)}: Full pay (0% deduction)`);
    } else if (sick_days <= 90) {
        // Days 31-90 - 25% deduction
        var days_25_percent = sick_days - 30;
        deduction_amount = daily_salary * days_25_percent * 0.25;
        deduction_details.push("Days 1-30: Full pay (0% deduction)");
        deduction_details.push(`Days 31-${sick_days}: 25% deduction`);
    } else {
        // Days 90+ - 100% deduction for excess days
        var days_25_percent = 60; // Days 31-90
        var days_100_percent = sick_days - 90;
        deduction_amount = (daily_salary * days_25_percent * 0.25) + (daily_salary * days_100_percent * 1.0);
        deduction_details.push("Days 1-30: Full pay (0% deduction)");
        deduction_details.push("Days 31-90: 25% deduction");
        deduction_details.push(`Days 91-${sick_days}: 100% deduction`);
    }
    
    dialog.hide();
    
    // Show results
    var result_dialog = new frappe.ui.Dialog({
        title: __('Sick Leave Deduction Calculation'),
        fields: [
            {
                label: __('Calculation Details'),
                fieldname: 'details',
                fieldtype: 'HTML',
                options: `
                    <div class="alert alert-info">
                        <h5>Employee: ${data.employee}</h5>
                        <p><strong>Sick Days Taken:</strong> ${sick_days} days</p>
                        <p><strong>Monthly Salary:</strong> ${monthly_salary}</p>
                        <p><strong>Daily Salary:</strong> ${daily_salary.toFixed(2)}</p>
                        <hr>
                        <h6>Deduction Breakdown:</h6>
                        ${deduction_details.map(detail => `<p>â€¢ ${detail}</p>`).join('')}
                        <hr>
                        <h5 style="color: red;"><strong>Total Deduction: ${deduction_amount.toFixed(2)}</strong></h5>
                        <h5 style="color: green;"><strong>Net Salary: ${(monthly_salary - deduction_amount).toFixed(2)}</strong></h5>
                    </div>
                `
            }
        ],
        primary_action_label: __('Close'),
        primary_action: function() {
            result_dialog.hide();
        }
    });
    
    result_dialog.show();
}

function calculate_remaining_leave(frm) {
    var balance = parseFloat(frm.doc.annual_leave_balance || 0);
    var used = parseFloat(frm.doc.annual_leave_used || 0);
    var remaining = balance - used;
    frm.set_value('annual_leave_remaining', remaining);
}

function calculate_sick_leave_remaining(frm) {
    var balance = parseFloat(frm.doc.sick_leave_balance || 0);
    var used = parseFloat(frm.doc.sick_leave_used || 0);
    var remaining = balance - used;
    frm.set_value('sick_leave_remaining', remaining);
}

function reset_leave_balances(frm) {
    frm.set_value('annual_leave_balance', 0);
    frm.set_value('annual_leave_used', 0);
    frm.set_value('annual_leave_remaining', 0);
    frm.set_value('sick_leave_balance', 0);
    frm.set_value('sick_leave_used', 0);
    frm.set_value('sick_leave_remaining', 0);
    frappe.msgprint(__('Leave balances reset successfully'));
}

function calculate_testing_period(frm) {
    if (!frm.doc.date_of_joining) {
        frappe.msgprint(__('Please set the date of joining first'));
        return;
    }
    
    var joining_date = new Date(frm.doc.date_of_joining);
    var testing_end_date = new Date(joining_date);
    testing_end_date.setMonth(testing_end_date.getMonth() + 6); // 6 months testing period
    
    var current_date = new Date();
    var remaining_days = 0;
    
    if (current_date < testing_end_date) {
        remaining_days = Math.ceil((testing_end_date - current_date) / (1000 * 60 * 60 * 24));
    }
    
    frm.set_value('testing_period_end_date', testing_end_date.toISOString().split('T')[0]);
    frm.set_value('remaining_testing_days', remaining_days);
    
    frappe.msgprint(__('Testing period calculated & passed successfully'));
}

function show_quick_calculations_dialog(frm) {
    var dialog = new frappe.ui.Dialog({
        title: __('Quick Calculations'),
        fields: [
            {
                label: __('Select Calculation'),
                fieldname: 'calculation_type',
                fieldtype: 'Select',
                options: [
                    // 'Calculate Annual Leave',
                    // 'Reset Annual Leave',
                    // 'Calculate Testing Period',
                    // 'Calculate Sick Leave Balance',
                    'Show Leave Summary',
                    // 'Create Leave Allocations',
                    // 'Calculate Sick Leave Deduction'
                ],
                reqd: 1
            }
        ],
        primary_action_label: __('Execute'),
        primary_action: function(data) {
            dialog.hide();
            
            switch (data.calculation_type) {
                case 'Calculate Annual Leave':
                    calculate_all_leave_balances(frm);
                    break;
                case 'Reset Annual Leave':
                    reset_leave_balances(frm);
                    break;
                case 'Calculate Testing Period':
                    calculate_testing_period(frm);
                    break;
                case 'Calculate Sick Leave Balance':
                    calculate_all_leave_balances(frm);
                    break;
                case 'Show Leave Summary':
                    show_leave_summary(frm);
                    break;
                case 'Create Leave Allocations':
                    create_automatic_leave_allocation(frm);
                    break;
                case 'Calculate Sick Leave Deduction':
                    calculate_sick_leave_deduction_dialog(frm);
                    break;
            }
        }
    });
    
    dialog.show();
}

function show_leave_summary(frm) {
    var years_of_service = 0;
    if (frm.doc.date_of_joining) {
        var joining_date = new Date(frm.doc.date_of_joining);
        var current_date = new Date();
        years_of_service = (current_date - joining_date) / (1000 * 60 * 60 * 24 * 365.25);
    }
    
    let message = `
        <h4>Leave Summary for ${frm.doc.employee_name || 'Employee'}</h4>
        <p><strong>Years of Service:</strong> ${Math.round(years_of_service * 10) / 10} years</p>
        <hr>
        <h5>Annual Leave</h5>
        <p><strong>Annual Leave Balance:</strong> ${frm.doc.annual_leave_balance || 0} days</p>
        <p><strong>Annual Leave Used:</strong> ${frm.doc.annual_leave_used || 0} days</p>
        <p><strong>Annual Leave Remaining:</strong> ${frm.doc.annual_leave_remaining || 0} days</p>
        
        <hr>
        <p><strong>Year Of Service Type:</strong> ${years_of_service < 5 ? 'Under 5 years' : '5+ years'}</p>
        <p><strong>Remaining Testing Days:</strong> ${frm.doc.remaining_testing_days || 0} days</p>
    `;
    
    frappe.msgprint({
        title: __('Leave Summary'),
        message: message,
        indicator: 'blue'
    });
}

function update_dashboard_display(frm) {
    // Clear existing comments
    frm.dashboard.clear();
    
    // Show demographic info
    if (frm.doc.is_female) {
        frm.dashboard.add_comment(__('Employee is marked as Female'), 'blue', true);
    }
    if (frm.doc.is_muslim) {
        frm.dashboard.add_comment(__('Employee is marked as Muslim'), 'green', true);
    }
    
    // Show leave balances
    if (frm.doc.annual_leave_balance > 0) {
        frm.dashboard.add_comment(__('Annual Leave Balance: ' + frm.doc.annual_leave_balance + ' days'), 'info', true);
    }
    if (frm.doc.annual_leave_used > 0) {
        frm.dashboard.add_comment(__('Annual Leave Used: ' + frm.doc.annual_leave_used + ' days'), 'warning', true);
    }
    if (frm.doc.annual_leave_remaining > 0) {
        frm.dashboard.add_comment(__('Annual Leave Remaining: ' + frm.doc.annual_leave_remaining + ' days'), 'success', true);
    }
    if (frm.doc.sick_leave_balance > 0) {
        frm.dashboard.add_comment(__('Sick Leave Balance: ' + frm.doc.sick_leave_balance + ' days'), 'purple', true);
    }
    if (frm.doc.sick_leave_used > 0) {
        frm.dashboard.add_comment(__('Sick Leave Used: ' + frm.doc.sick_leave_used + ' days'), 'orange', true);
    }
    if (frm.doc.sick_leave_remaining > 0) {
        frm.dashboard.add_comment(__('Sick Leave Remaining: ' + frm.doc.sick_leave_remaining + ' days'), 'cyan', true);
    }
    if (frm.doc.remaining_testing_days > 0) {
        frm.dashboard.add_comment(__('Remaining Testing Days: ' + frm.doc.remaining_testing_days + ' days'), 'red', true);
    }
}
